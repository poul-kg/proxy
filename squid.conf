# Squid Caching Proxy with SSL Bump
# Optimized for caching package manager downloads (apt, npm, pip, go, etc.)

# --- Port & SSL Bump ---
http_port 3128 ssl-bump \
    cert=/etc/squid/certs/ca.pem \
    key=/etc/squid/certs/ca.key \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=16 MB

sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/spool/squid/ssl_db -M 16MB
sslcrtd_children 8 startup=1 idle=1

# Bump all HTTPS connections
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# --- ACLs ---
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl Safe_ports port 1025-65535

acl CONNECT method CONNECT

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_access deny all

# --- Cache Storage ---
# rock store type is SSD-friendly (single large file instead of many small files)
cache_dir rock /var/spool/squid 102400 swap-timeout=20

# RAM cache for frequently accessed objects
cache_mem 512 MB

# Maximum cached object size (1GB for large packages/tarballs)
maximum_object_size 1 GB
maximum_object_size_in_memory 64 MB

# --- Aggressive Caching / Long Retention ---
# Format: refresh_pattern regex min_age(minutes) percent max_age(minutes)
# 43200 min = 30 days, 525600 min = 365 days

# Debian/Ubuntu packages
refresh_pattern \.deb$                  525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private
refresh_pattern \.udeb$                 525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private
refresh_pattern Packages\.gz$           1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store
refresh_pattern Packages\.xz$           1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store
refresh_pattern Release$                1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store
refresh_pattern Release\.gpg$           1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store
refresh_pattern InRelease$              1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store
refresh_pattern Sources\.gz$            1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store

# npm packages
refresh_pattern \.tgz$                  525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private
refresh_pattern registry\.npmjs\.org    1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store

# Python packages
refresh_pattern \.whl$                  525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private
refresh_pattern \.tar\.gz$              525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private
refresh_pattern pypi\.org               1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store
refresh_pattern files\.pythonhosted\.org 525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private

# Go modules
refresh_pattern proxy\.golang\.org      1440    100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store
refresh_pattern \.zip$                  525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private
refresh_pattern \.mod$                  525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private

# Generic archives
refresh_pattern \.rpm$                  525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private
refresh_pattern \.xz$                   525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private
refresh_pattern \.bz2$                  525600  100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private

# Default: cache everything aggressively
refresh_pattern .                       43200   100%  525600  override-expire override-lastmod ignore-no-cache ignore-no-store ignore-private

# --- Logging ---
access_log daemon:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log none

# --- Performance ---
dns_nameservers 1.1.1.1 8.8.8.8
positive_dns_ttl 6 hours
negative_dns_ttl 1 minute
connect_timeout 30 seconds
read_timeout 5 minutes

# Don't cache based on content-type mismatches
range_offset_limit -1

# Store incomplete responses (useful for large downloads that get interrupted)
quick_abort_min -1

# Allow caching of all response codes that make sense
negative_ttl 0 seconds

# Visible hostname
visible_hostname squid-proxy

# Shutdown timeout
shutdown_lifetime 5 seconds
